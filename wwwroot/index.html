<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Sistema de Inventario</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Formulario de Login -->
    <div id="login-container">
        <h2>Iniciar Sesión</h2>
        <form id="login-form">
            <input type="text" id="login-usuario" placeholder="Usuario" required><br>
            <input type="password" id="login-contraseña" placeholder="Contraseña" required><br>
            <button type="submit">Entrar</button>
        </form>
        <div id="login-error" style="color:red; font-weight:bold;"></div>
        <hr>
        <h3>Registrar nuevo usuario</h3>
        <form id="register-form">
            <input type="text" id="register-usuario" placeholder="Usuario" required><br>
            <input type="password" id="register-contraseña" placeholder="Contraseña" required><br>
            <button type="submit">Registrar</button>
        </form>
        <div id="register-error" style="color:red; font-weight:bold;"></div>
        <div id="register-success" style="color:green; font-weight:bold;"></div>
    </div>

    <div id="main-content" style="display:none;">
        <button id="btn-logout" style="float:right; margin:10px;">Salir</button>
        <!-- ...todo el contenido actual de tu página... -->
        <h1>ERP CanchesTechnology</h1>

        <!-- Menú principal -->
        <nav>
            <button onclick="mostrarVista('inventario')">Gestión de Inventario</button>
            <button onclick="mostrarVista('compras')">Gestión de Compras</button>
        </nav>

        <!-- Vista Inventario -->
        <section id="inventario" class="seccion">
            <h2>Submódulos complementarios</h2>

            <!-- Submenú -->
            <div class="submenu">
                <button onclick="mostrarSubSeccion('productos')">Productos</button>
                <button onclick="mostrarSubSeccion('proveedores')">Proveedores</button>
                <button onclick="mostrarSubSeccion('pedidos')">Pedidos</button>
                <button onclick="mostrarSubSeccion('ubicaciones')">Ubicaciones</button>
                <button onclick="mostrarSubSeccion('reportes')">Reportes</button>
            </div>

            <!-- Subapartados -->
            <div id="subapartados-compras">

                <!-- Productos -->
                <section id="productos" class="subseccion">
                    <h3>Productos</h3>
                    <div id="alerta-reabastecimiento" style="display:none; color:red; font-weight:bold; margin:10px 0;"></div>
                    <label>
                        <input type="checkbox" id="filtro-bajo-stock" onchange="cargarProductos()">
                        Mostrar solo productos bajo stock
                    </label>

                    <table id="tabla-productos">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Cantidad</th>
                                <th>Precio</th>
                                <th>Costo</th>
                                <th>Ganancia Unidad</th>
                                <th>Ganancia Total</th>
                                <th>Stock Mínimo</th>
                                <th>Proveedor</th>
                                <th>Ubicación</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <h4>Gestión de Producto</h4>
                    <form id="form-producto" onsubmit="agregarProducto(event)">
                        <input type="hidden" id="hiddenProductoId">
                        <input type="text" id="nombre" placeholder="Nombre" required>
                        <input type="number" id="cantidad" placeholder="Cantidad" required>
                        <input type="number" id="precio" placeholder="Precio" step="0.01" required>
                        <input type="number" id="costo" placeholder="Costo" step="0.01" required>
                        <input type="number" id="stockMinimo" placeholder="Stock Mínimo" required>
                        <select id="proveedorId" required>
                            <option value="">-- Selecciona Proveedor --</option>
                        </select>
                        <select id="ubicacionId" required>
                            <option value="">-- Selecciona Ubicación --</option>
                        </select>
                        <button type="submit">Agregar</button>
                        <button type="button" onclick="actualizarProducto()">Actualizar</button>
                        <button type="button" onclick="limpiarFormulario('form-producto')">Limpiar Campos</button>
                    </form>
                </section>

                <!-- Proveedores -->
                <section id="proveedores" class="subseccion hidden">
                    <h3>Proveedores</h3>
                    <table id="tabla-proveedores">
                        <thead>
                            <tr><th>ID</th><th>Nombre</th><th>Contacto</th><th>Email</th><th>Acciones</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <h4>Gestión de Proveedor</h4>
                    <form id="form-proveedor" onsubmit="agregarProveedor(event)">
                        <input type="hidden" id="proveedorId">
                        <input type="text" id="prov-nombre" placeholder="Nombre" required>
                        <input type="text" id="prov-contacto" placeholder="Contacto" required>
                        <input type="email" id="prov-email" placeholder="Email" required>
                        <button type="submit">Agregar</button>
                        <button type="button" onclick="actualizarProveedor()">Actualizar</button>
                        <button type="button" onclick="limpiarFormulario('form-proveedor')">Limpiar Campos</button>
                    </form>
                </section>

                <!-- Ubicaciones -->
                <section id="ubicaciones" class="subseccion hidden">
                    <h3>Ubicaciones</h3>
                    <table id="tabla-ubicaciones">
                        <thead>
                            <tr><th>ID</th><th>Código</th><th>Descripción</th><th>Acciones</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <h4>Gestión de Ubicación</h4>
                    <form id="form-ubicacion" onsubmit="agregarUbicacion(event)">
                        <input type="hidden" id="ubicacionId">
                        <input type="text" id="ubicacion-codigo" placeholder="Código" required>
                        <input type="text" id="ubicacion-descripcion" placeholder="Descripción" required>
                        <button type="submit">Guardar</button>
                        <button type="button" onclick="actualizarUbicacion()">Actualizar</button>
                        <button type="button" onclick="limpiarFormulario('form-ubicacion')">Limpiar Campos</button>
                    </form>
                    <p id="ubicacion-error" style="color:red;font-weight:bold;"></p>
                </section>

                <!-- Pedidos -->
                <section id="pedidos" class="subseccion hidden">
                    <h3>Pedidos</h3>
                    <table id="tabla-pedidos">
                        <thead>
                            <tr><th>ID</th><th>Fecha</th><th>Cliente</th><th>Detalles</th><th>Acciones</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <h4>Gestión de Pedido</h4>
                    <form id="form-pedido" onsubmit="agregarPedido(event)">
                        <input type="hidden" id="pedidoId">
                        <input type="text" id="pedido-cliente" placeholder="Cliente" required>

                        <table id="tabla-detalles">
                            <thead>
                                <tr><th>Producto</th><th>Cantidad</th><th>Precio Unitario</th><th>Acciones</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                        <!-- Selector para agregar productos -->
                        <div>
                            <select id="detalle-productoId">
                                <option value="">-- Selecciona Producto --</option>
                            </select>
                            <input type="number" id="detalle-cantidad" placeholder="Cantidad" required>
                            <input type="text" id="detalle-precio" placeholder="Precio Unitario" readonly>
                            <button type="button" onclick="agregarDetalle()">Agregar Producto</button>
                            <button type="button" onclick="limpiarFormulario('form-pedido')">Limpiar Campos</button>
                        </div>

                        <button type="submit">Guardar Pedido</button>
                        <button type="button" onclick="actualizarPedido()">Actualizar</button>
                    </form>
                </section>

                <!-- Reportes -->
                <section id="reportes" class="subseccion hidden">

                    <h2>📊 Reportes de Inventario</h2>
                    <div id="reporte-resumen"></div>
                    <button onclick="exportarExcelInventario()">📊 Exportar a Excel</button>
                    <h3>⚠️ Productos con bajo stock</h3>
                    <ul id="reporte-bajo-stock"></ul>
                    <button onclick="exportarExcelStockBajo()">📉 Exportar Stock Bajo</button>

                    <h3>Productos por Ubicación</h3>
                    <div id="reporte-por-ubicacion"></div>

                    <button onclick="exportarExcelPorUbicacion()">📊Exportar Excel por Ubicación</button>


                    <h3>📈 Márgenes de Ganancia por Producto</h3>
                    <table id="reporte-margenes">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Costo Unitario</th>
                                <th>Precio Unitario</th>
                                <th>Margen (%)</th>
                                <th>Ganancia Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <button onclick="exportarExcelMargenes()">📊 Exportar Márgenes a Excel</button>


                    <h3>📑 Histórico de Compras a Proveedores</h3>
                    <div id="reporte-compras"></div>
                    <button onclick="exportarExcelCompras()">📊 Exportar a Excel</button>


                </section>
            </div>
        </section>


        <!-- ================== VISTA GESTIÓN DE COMPRAS ================== -->
        <section id="compras" class="seccion hidden">
            <h2>Gestión de Compras</h2>

            <div class="submenu">
                <button onclick="mostrarSubSeccion('solicitudes')">Solicitudes de Compra</button>
                <button onclick="mostrarSubSeccion('ordenes')">Órdenes de Compra</button>
            </div>

            <div id="subapartados-inventario">

                <!-- Solicitudes de Compra -->
                <section id="solicitudes" class="subseccion hidden">
                    <h3>Solicitudes de Compra</h3>

                    <table id="tabla-solicitudes">
                        <thead>
                            <tr><th>ID</th><th>Fecha</th><th>Estado</th><th>Cantidad</th><th>Acciones</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>

                    <h4>Nueva Solicitud</h4>
                    <form id="form-solicitud" onsubmit="agregarSolicitud(event)">
                        <input type="hidden" id="solicitudId">

                        <select id="solicitud-proveedorId" onchange="filtrarProductosPorProveedorSolicitud()">
                            <option value="">-- Selecciona Proveedor --</option>
                        </select>

                        <table id="tabla-detalles-solicitud">
                            <thead>
                                <tr><th>Producto</th><th>Cantidad</th><th>Costo</th><th>Acciones</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                        <div>
                            <select id="solicitud-productoId">
                                <option value="">-- Selecciona Producto --</option>
                            </select>
                            <input type="number" id="solicitud-cantidad" placeholder="Cantidad">
                            <input type="number" id="solicitud-costo" placeholder="Costo Unitario" readonly>
                            <button type="button" onclick="agregarDetalleSolicitud()">Agregar Producto</button>
                        </div>

                        <button type="submit">Guardar Solicitud</button>
                        <button type="button" onclick="generarSolicitudAutomatica()">Generar Automática</button>
                    </form>
                </section>


                <!-- Órdenes de Compra -->
                <section id="ordenes" class="subseccion hidden">
                    <h3>Órdenes de Compra</h3>

                    <table id="tabla-ordenes">
                        <thead>
                            <tr><th>ID</th><th>Fecha</th><th>Proveedor</th><th>Estado</th><th>Detalles</th><th>Acciones</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </section>
            </div>
        </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

    <script src="app.js"></script>

    <script>
        document.getElementById('login-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const usuario = document.getElementById('login-usuario').value;
            const contraseña = document.getElementById('login-contraseña').value;
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = '';
            try {
                const resp = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombreUsuario: usuario, contraseña })
                });
                if (resp.ok) {
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('main-content').style.display = '';
                } else {
                    const data = await resp.json();
                    errorDiv.textContent = data || 'Usuario o contraseña incorrectos';
                }
            } catch {
                errorDiv.textContent = 'Error de conexión con el servidor.';
            }
        });

        document.getElementById('register-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const usuario = document.getElementById('register-usuario').value;
            const contraseña = document.getElementById('register-contraseña').value;
            const errorDiv = document.getElementById('register-error');
            const successDiv = document.getElementById('register-success');
            errorDiv.textContent = '';
            successDiv.textContent = '';
            try {
                const resp = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nombreUsuario: usuario, contraseña })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    successDiv.textContent = data.mensaje || 'Usuario registrado correctamente';
                } else {
                    const data = await resp.json();
                    errorDiv.textContent = data || 'Error al registrar usuario';
                }
            } catch {
                errorDiv.textContent = 'Error de conexión con el servidor.';
            }
        });

        document.getElementById('btn-logout').addEventListener('click', function () {
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('login-container').style.display = '';
            // Limpiar campos y mensajes
            document.getElementById('login-usuario').value = '';
            document.getElementById('login-contraseña').value = '';
            document.getElementById('login-error').textContent = '';
        });
    </script>
</body>
</html>


